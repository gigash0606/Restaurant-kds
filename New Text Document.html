<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pannello Stato Ordini KDS (Demo Online con Firebase)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .text-shadow-lg { text-shadow: 2px 2px 4px rgba(0,0,0,0.6); }
    .animate-pulse-making {
      animation: pulse-making 1.5s cubic-bezier(0.4,0,0.6,1) infinite;
    }
    @keyframes pulse-making {
      0%,100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.03); }
    }
    .grid-kds {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 1.5rem;
    }
    @media (min-width: 640px) {
      .grid-kds {
        grid-template-columns: repeat(6, 1fr);
      }
    }
    .order-button {
      width: 100%;
      aspect-ratio: 1/1;
      font-size: 2.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.5);
      transition: transform .25s;
      cursor: pointer;
    }
    .order-button:hover {
      transform: scale(1.05);
    }
  </style>
</head>

<body class="bg-gray-800 p-4 min-h-screen">

  <header class="bg-gray-900 p-4 rounded-xl mb-4 border-b-4 border-indigo-600">
    <h1 class="text-3xl text-white font-extrabold text-center">
      Pannello Stato Ordini (DEMO Online Firebase)
    </h1>
  </header>

  <div id="message-container" class="p-3 bg-gray-900 text-white text-sm rounded-lg mb-4">
    <p id="system-message">Caricamento dati...</p>
  </div>

  <main class="bg-gray-900 rounded-xl p-4 shadow-xl">
    <div id="kds-grid" class="grid grid-kds gap-4 sm:gap-6 p-2"></div>
  </main>

  <!-- MODAL -->
  <div id="confirmation-modal"
       class="fixed inset-0 bg-black bg-opacity-70 items-center justify-center p-4 hidden z-50">
    <div class="bg-gray-900 text-white rounded-xl shadow-2xl w-full max-w-sm p-6">
      <h3 id="modal-table-number" class="text-4xl font-extrabold text-center mb-4"></h3>
      <p id="modal-status-preview" class="text-lg text-center font-medium mb-6"></p>

      <div class="flex justify-around">
        <button id="cancel-button"
                class="w-24 h-24 text-5xl bg-red-700 hover:bg-red-600 rounded-full shadow-xl flex items-center justify-center">
          ✖
        </button>

        <button id="confirm-button"
                class="w-24 h-24 text-5xl bg-green-600 hover:bg-green-500 rounded-full shadow-xl flex items-center justify-center">
          ✔
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBM5yvJgNt8-cBPa58wUzE3TbWZREWGqCg",
      authDomain: "kds-26.firebaseapp.com",
      databaseURL: "https://kds-26-default-rtdb.firebaseio.com",
      projectId: "kds-26",
      storageBucket: "kds-26.firebasestorage.app",
      messagingSenderId: "199994611000",
      appId: "1:199994611000:web:11d238d463d0881f039dcd",
      measurementId: "G-PP210K3L6J"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const ordersRef = database.ref('orders');

    const STATUS_MAP = {
      pending: { color: 'bg-gray-600', label: 'Aperto' },
      making: { color: 'bg-yellow-500', label: 'In Prep' },
      ready: { color: 'bg-green-500', label: 'Pronto' }
    };

    const STATUS_ORDER = ['pending', 'making', 'ready'];

    let mockOrders = [];

    // UI Functions
    const setMessage = (msg) => {
      document.getElementById("system-message").textContent = msg;
    };

    const openModal = (order) => {
      orderToUpdate = order;

      const currentIndex = STATUS_ORDER.indexOf(order.status);
      const nextStatus = STATUS_ORDER[(currentIndex + 1) % STATUS_ORDER.length];

      nextStatusToApply = nextStatus;

      document.getElementById("modal-table-number").innerHTML =
        `Tavolo <span class="text-indigo-400">${order.number}</span>`;

      document.getElementById("modal-status-preview").innerHTML =
        `Attuale: <b>${STATUS_MAP[order.status].label}</b> → Prossimo: <b>${STATUS_MAP[nextStatus].label}</b>`;

      const modal = document.getElementById("confirmation-modal");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    };

    const closeModal = () => {
      const modal = document.getElementById("confirmation-modal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    };

    const renderButtons = () => {
      const grid = document.getElementById("kds-grid");
      grid.innerHTML = "";

      mockOrders.forEach(order => {
        const btn = document.createElement("button");

        btn.className =
          `order-button text-white font-extrabold ${STATUS_MAP[order.status].color}`;

        if (order.status === 'making') {
          btn.classList.add("animate-pulse-making", "ring-4", "ring-yellow-300");
        }

        btn.innerHTML = `<span class="text-shadow-lg">${order.number}</span>`;
        btn.onclick = () => openModal(order);

        grid.appendChild(btn);
      });
    };

    // Update logic
    let orderToUpdate = null;
    let nextStatusToApply = null;

    const applyUpdate = () => {
      if (!orderToUpdate || !nextStatusToApply) return;

      ordersRef.child(orderToUpdate.id).update({ status: nextStatusToApply })
        .then(() => {
          setMessage(`Tavolo ${orderToUpdate.number} aggiornato a: ${STATUS_MAP[nextStatusToApply].label}`);
          closeModal();
        })
        .catch(error => {
          setMessage(`Errore aggiornamento: ${error.message}`);
        });
    };

    document.getElementById("confirm-button").onclick = applyUpdate;
    document.getElementById("cancel-button").onclick = closeModal;

    // Initialize orders if not already present in Firebase
    ordersRef.once('value').then(snapshot => {
      if (!snapshot.exists()) {
        const initialOrders = {};
        for (let i = 1; i <= 26; i++) {
          initialOrders[String(i)] = { id: String(i), number: i, status: 'pending' };
        }
        ordersRef.set(initialOrders)
          .then(() => {
            console.log("Initialized orders in Firebase.");
          })
          .catch(error => {
            console.error("Error initializing orders:", error);
          });
      }
    });

    // Listen for realtime updates on orders
    ordersRef.on('value', snapshot => {
      const data = snapshot.val();
      if (data) {
        mockOrders = Object.values(data);
      } else {
        mockOrders = [];
      }
      renderButtons();
      setMessage("Sistema operativo (Modalità Online - Dati Firebase)");
    });
  </script>

</body>
</html>
